{% extends "base.html" %}

{% block title %}Credentials - Verifone Invoice Management{% endblock %}

{% block content %}
<style>
    /* Global Container - Ancho completo */
    .dashboard-container {
        width: 100%;
        margin: 0;
        height: calc(100vh - 45px);
        display: flex;
        flex-direction: column;
    }

    /* Tab System Compacto */
    .tabs-container {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 100;
        border-bottom: 2px solid #e5e7eb;
        flex-shrink: 0;
    }

    .tabs {
        display: flex;
        gap: 0;
        padding: 0;
        margin: 0;
        list-style: none;
        overflow-x: auto;
    }

    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
        color: #666;
        font-weight: 600;
        font-size: 13px;
        background: transparent;
    }

    .tab:hover {
        background: #e9ecef;
        color: #333;
    }

    .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: white;
    }

    /* Content Area - Aprovechar ancho completo */
    .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 15px 20px;
        max-width: 100%;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s;
        width: 100%;
        box-sizing: border-box;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Card System Compacto */
    .card {
        background: white;
        border-radius: 8px;
        padding: 15px 20px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        margin-bottom: 15px;
        border: 1px solid #e5e7eb;
        width: 100%;
        box-sizing: border-box;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f0f0;
    }

    .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .card-subtitle {
        color: #666;
        font-size: 12px;
        margin: 3px 0 0 0;
    }

    /* Two Column Layout - Aprovechar ancho completo */
    .two-column-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        width: 100%;
    }

    @media (max-width: 1024px) {
        .two-column-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Form Elements Compactos */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #333;
        font-size: 13px;
    }

    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 13px;
        transition: border-color 0.2s;
        box-sizing: border-box;
    }

    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-group textarea {
        font-family: 'Courier New', monospace;
        resize: vertical;
        min-height: 140px;
    }

    /* Scrollable Panel Compacto */
    .scrollable-panel {
        max-height: 350px;
        overflow-y: auto;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }

    .scrollable-panel::-webkit-scrollbar {
        width: 8px;
    }

    .scrollable-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .scrollable-panel::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .scrollable-panel::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Accordion Compacto */
    .accordion {
        margin-bottom: 12px;
    }

    .accordion-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 16px;
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        font-size: 14px;
    }

    .accordion-header:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
    }

    .accordion-header.active {
        border-radius: 6px 6px 0 0;
    }

    .accordion-icon {
        transition: transform 0.2s;
        font-size: 12px;
    }

    .accordion-header.active .accordion-icon {
        transform: rotate(180deg);
    }

    .accordion-content {
        display: none;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #667eea;
        border-top: none;
        border-radius: 0 0 6px 6px;
        font-size: 13px;
    }

    .accordion-content.active {
        display: block;
    }

    /* Button Styles Compactos */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
        background: #4caf50;
        color: white;
    }

    .btn-success:hover {
        background: #45a049;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3);
    }

    .btn-secondary {
        background: #ff9800;
        color: white;
    }

    .btn-secondary:hover {
        background: #f57c00;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Code Display Compacto */
    .code-display {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 12px 15px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        line-height: 1.5;
        width: 100%;
        box-sizing: border-box;
    }

    /* Status Badge Compacto */
    .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-badge.success {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.error {
        background: #f8d7da;
        color: #721c24;
    }

    /* Credential Item Compacto */
    .credential-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: white;
        border-radius: 4px;
        margin-bottom: 6px;
        border: 1px solid #e0e0e0;
    }

    .credential-name {
        font-family: monospace;
        font-size: 12px;
        color: #333;
    }

    .credential-icon {
        color: #4caf50;
        font-size: 14px;
    }

    /* Work Order List Compacto */
    .work-order-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .work-order-item {
        padding: 8px;
        background: white;
        border-radius: 4px;
        margin-bottom: 5px;
        font-family: monospace;
        font-size: 12px;
        border: 1px solid #e0e0e0;
    }

    /* Alert Box Compacto */
    .alert-box {
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
    }

    .alert-box.success {
        background: #d4edda;
        border-left: 3px solid #28a745;
        color: #155724;
    }

    .alert-box.error {
        background: #f8d7da;
        border-left: 3px solid #dc3545;
        color: #721c24;
    }

    .alert-box.info {
        background: #d1ecf1;
        border-left: 3px solid #17a2b8;
        color: #0c5460;
    }

    /* Empty State Compacto */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 40px;
        margin-bottom: 12px;
    }

    /* Action Bar Compacto */
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 12px;
    }

    /* Responsive - Pantallas ultra anchas */
    @media (min-width: 1920px) {
        .content-area {
            padding: 15px 40px;
        }

        .two-column-grid {
            gap: 30px;
        }

        .card {
            padding: 20px 30px;
        }
    }

    /* Responsive - Tablets */
    @media (max-width: 768px) {
        .content-area {
            padding: 12px 15px;
        }

        .two-column-grid {
            gap: 15px;
        }
    }
</style>

<div class="dashboard-container">
    <!-- Alert Container -->
    <div id="alerts"></div>

    <!-- Tabs Compactos -->
    <div class="tabs-container">
        <ul class="tabs">
            <li class="tab active" data-tab="update">üìù Update Credentials</li>
            <li class="tab" data-tab="test">üß™ Test Header</li>
            <li class="tab" data-tab="status">üìä Current Status</li>
            <li class="tab" data-tab="guide">üìñ Quick Guide</li>
        </ul>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Tab 1: Update Credentials -->
        <div class="tab-content active" id="tab-update">
            <div class="two-column-grid">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Update from Browser Request</h3>
                            <p class="card-subtitle">Paste DevTools request or cURL command</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="credentialType">Credential Type:</label>
                        <select id="credentialType">
                            <option value="HEADER">üîµ HEADER - Work Orders List</option>
                            <option value="FIRST">üü¢ FIRST - Work Order Details</option>
                            <option value="PII">üü° PII - Personal Information</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="requestText">Request Text:</label>
                        <textarea id="requestText" rows="12" placeholder="Paste your request here...

Example formats accepted:
‚Ä¢ Complete cURL command
‚Ä¢ DevTools Network tab request (all details)
‚Ä¢ Raw request headers and body"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="parseAndUpdate()">
                        üöÄ Parse & Update Credentials
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Instructions</h3>
                            <p class="card-subtitle">How to capture credentials</p>
                        </div>
                    </div>

                    <div class="scrollable-panel">
                        <ol style="color: #666; line-height: 1.6; font-size: 13px;">
                            <li><strong>Open Verifone</strong> in another browser tab</li>
                            <li><strong>Open DevTools</strong> (Press <kbd>F12</kbd>)</li>
                            <li>Go to the <strong>Network</strong> tab</li>
                            <li><strong>Perform the action:</strong>
                                <ul style="margin-top: 6px;">
                                    <li>For HEADER: Load Work Orders list</li>
                                    <li>For FIRST: Click on a Work Order</li>
                                    <li>For PII: View Personal Information</li>
                                </ul>
                            </li>
                            <li>Find the request to <code style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px;">aura</code></li>
                            <li><strong>Right-click</strong> ‚Üí Copy ‚Üí <strong>Copy as cURL</strong></li>
                            <li>Or copy all request details manually</li>
                            <li>Paste in the form and click <strong>Parse & Update</strong></li>
                        </ol>

                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                            <strong style="color: #856404; font-size: 13px;">üí° Pro Tip:</strong>
                            <p style="margin: 4px 0 0 0; color: #856404; font-size: 12px;">You can paste the entire cURL command directly - the system will parse it automatically!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Test Header -->
        <div class="tab-content" id="tab-test">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Test Header Request</h3>
                        <p class="card-subtitle">Verify HEADER credentials by fetching work orders</p>
                    </div>
                    <button class="btn btn-success" onclick="testHeader()" id="testHeaderBtn">
                        üöÄ Run Test
                    </button>
                </div>

                <div id="testResults" style="display: none;">
                    <div class="two-column-grid">
                        <!-- cURL Command -->
                        <div>
                            <div class="action-bar">
                                <h4 style="margin: 0; font-size: 14px;">üîß cURL Command</h4>
                                <button class="btn btn-secondary btn-small" onclick="copyCurlToClipboard()">
                                    üìã Copy
                                </button>
                            </div>
                            <div class="code-display">
                                <pre id="curlCommandText" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
                            </div>
                        </div>

                        <!-- JSON Response -->
                        <div>
                            <div class="action-bar">
                                <h4 style="margin: 0; font-size: 14px;">üìä JSON Response</h4>
                                <button class="btn btn-secondary btn-small" onclick="copyJsonToClipboard()">
                                    üìã Copy
                                </button>
                            </div>
                            <div class="code-display">
                                <pre id="testResultsText" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div id="testSummary" style="margin-top: 15px;"></div>
                </div>

                <div id="testEmpty" class="empty-state">
                    <div class="empty-state-icon">üß™</div>
                    <h3>No Test Results Yet</h3>
                    <p>Click "Run Test" to verify your HEADER credentials</p>
                </div>
            </div>
        </div>

        <!-- Tab 3: Current Status -->
        <div class="tab-content" id="tab-status">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Current Credentials</h3>
                        <p class="card-subtitle">Active credentials in the system</p>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="loadCredentials()">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="two-column-grid">
                    <div>
                        <h4 style="margin-bottom: 12px; font-size: 14px;">üîë Tokens</h4>
                        <div id="tokensList" class="scrollable-panel">
                            <p style="color: #999; text-align: center; font-size: 13px;">Loading...</p>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 12px; font-size: 14px;">üç™ Cookies</h4>
                        <div id="cookiesList" class="scrollable-panel">
                            <p style="color: #999; text-align: center; font-size: 13px;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Quick Guide -->
        <div class="tab-content" id="tab-guide">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìñ Quick Reference Guide</h3>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>What are HEADER credentials?</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <p><strong>HEADER credentials</strong> are used to fetch the list of Work Orders from Verifone.</p>
                        <p style="margin-top: 8px;">They include:</p>
                        <ul style="margin-left: 20px; margin-top: 6px;">
                            <li>AURA_TOKEN_HEADER</li>
                            <li>Session cookies</li>
                            <li>Entity and filter names</li>
                        </ul>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>What are FIRST credentials?</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <p><strong>FIRST credentials</strong> are used to fetch detailed information about a specific Work Order.</p>
                        <p style="margin-top: 8px;">They include:</p>
                        <ul style="margin-left: 20px; margin-top: 6px;">
                            <li>AURA_TOKEN (main token)</li>
                            <li>Record descriptors</li>
                        </ul>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>What are PII credentials?</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <p><strong>PII credentials</strong> are used to fetch sensitive personal information (Terminal ID, address, etc.).</p>
                        <p style="margin-top: 8px;">They include:</p>
                        <ul style="margin-left: 20px; margin-top: 6px;">
                            <li>AURA_TOKEN_PII</li>
                            <li>Flow parameters</li>
                        </ul>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>When do credentials expire?</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <p>Credentials typically expire when:</p>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            <li>Session timeout (usually after 2-4 hours)</li>
                            <li>User logs out from Verifone</li>
                            <li>Tokens are invalidated</li>
                        </ul>
                        <div style="margin-top: 12px; padding: 10px; background: #d1ecf1; border-radius: 4px;">
                            <strong style="color: #0c5460; font-size: 13px;">üí° Best Practice:</strong>
                            <p style="margin: 4px 0 0 0; color: #0c5460; font-size: 12px;">Update credentials whenever you start a new invoice generation session</p>
                        </div>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <span>Common Issues & Solutions</span>
                        <span class="accordion-icon">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <h4 style="margin-bottom: 8px; font-size: 14px;">üî¥ Error: "Invalid or expired token"</h4>
                        <p><strong>Solution:</strong> Update your credentials using a fresh cURL from DevTools</p>

                        <h4 style="margin-top: 15px; margin-bottom: 8px; font-size: 14px;">üü° Error: "No work orders found"</h4>
                        <p><strong>Solution:</strong> Check if HEADER credentials are correct and session is active</p>

                        <h4 style="margin-top: 15px; margin-bottom: 8px; font-size: 14px;">üü† Error: "Permission denied"</h4>
                        <p><strong>Solution:</strong> Make sure you're logged into Verifone with proper permissions</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab Switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const targetTab = this.dataset.tab;

        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Add active class to clicked tab and corresponding content
        this.classList.add('active');
        document.getElementById('tab-' + targetTab).classList.add('active');
    });
});

// Accordion Toggle
function toggleAccordion(header) {
    header.classList.toggle('active');
    const content = header.nextElementSibling;
    content.classList.toggle('active');
}

// Load credentials on page load
window.addEventListener('load', loadCredentials);

function loadCredentials() {
    const tokensList = document.getElementById('tokensList');
    const cookiesList = document.getElementById('cookiesList');

    tokensList.innerHTML = `
        <div class="credential-item">
            <span class="credential-name">AURA_TOKEN_HEADER</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div class="credential-item">
            <span class="credential-name">AURA_TOKEN</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div class="credential-item">
            <span class="credential-name">AURA_TOKEN_PII</span>
            <span class="credential-icon">‚úì</span>
        </div>
    `;

    cookiesList.innerHTML = `
        <div class="credential-item">
            <span class="credential-name">COOKIE_SID</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div class="credential-item">
            <span class="credential-name">COOKIE_BROWSER_ID</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div class="credential-item">
            <span class="credential-name">COOKIE_CLIENT_SRC</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div class="credential-item">
            <span class="credential-name">COOKIE_OID</span>
            <span class="credential-icon">‚úì</span>
        </div>
        <div style="text-align: center; color: #999; margin-top: 8px; font-size: 12px;">
            ... and 10 more cookies
        </div>
    `;
}

function parseAndUpdate() {
    const requestText = document.getElementById('requestText').value.trim();
    const credentialType = document.getElementById('credentialType').value;

    if (!requestText) {
        showAlert('Please paste the request text', 'error');
        return;
    }

    showAlert('Parsing request...', 'info');

    fetch('/api/parse-request', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            request_text: requestText,
            credential_type: credentialType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return fetch('/api/update-credentials', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    credentials: data.credentials
                })
            });
        } else {
            throw new Error(data.error || 'Failed to parse request');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('‚úÖ Credentials updated successfully!', 'success');
            document.getElementById('requestText').value = '';
            loadCredentials();
        } else {
            throw new Error(data.error || 'Failed to update credentials');
        }
    })
    .catch(error => {
        showAlert('‚ùå Error: ' + error.message, 'error');
    });
}

function testHeader() {
    const btn = document.getElementById('testHeaderBtn');
    const resultsDiv = document.getElementById('testResults');
    const emptyDiv = document.getElementById('testEmpty');
    const resultsText = document.getElementById('testResultsText');
    const curlText = document.getElementById('curlCommandText');
    const summaryDiv = document.getElementById('testSummary');

    // Disable button
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Testing...';

    // Hide empty state, show results container
    emptyDiv.style.display = 'none';
    resultsDiv.style.display = 'block';

    showAlert('Testing HEADER credentials...', 'info');

    fetch('/api/test-header', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = 'üöÄ Run Test';

        // Show cURL command
        if (data.curl_command) {
            curlText.textContent = data.curl_command;
        } else {
            curlText.textContent = '// cURL command not available';
        }

        if (data.success) {
            // Format JSON
            const displayData = {...data};
            delete displayData.curl_command;
            resultsText.textContent = JSON.stringify(displayData, null, 2);

            const totalWorkOrders = data.total_work_orders || (data.work_order_ids ? data.work_order_ids.length : 0);

            summaryDiv.innerHTML = `
                <div class="alert-box success">
                    <div style="font-size: 20px;">‚úÖ</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 4px 0; font-size: 14px;">Test Successful!</h4>
                        <p style="margin: 0; font-size: 13px;"><strong>Total Work Orders:</strong> ${totalWorkOrders}</p>
                    </div>
                </div>
                <div class="card">
                    <h4 style="margin-bottom: 12px; font-size: 14px;">Work Order IDs:</h4>
                    <div class="work-order-list">
                        ${data.work_order_ids ? data.work_order_ids.map(id => `<div class="work-order-item">${id}</div>`).join('') : '<p style="color: #999; font-size: 13px;">No IDs available</p>'}
                    </div>
                </div>
            `;

            showAlert('‚úÖ Header test successful!', 'success');
        } else {
            // Format error JSON
            const displayData = {...data};
            delete displayData.curl_command;
            resultsText.textContent = JSON.stringify(displayData, null, 2);

            summaryDiv.innerHTML = `
                <div class="alert-box error">
                    <div style="font-size: 20px;">‚ùå</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 4px 0; font-size: 14px;">Test Failed</h4>
                        <p style="margin: 0; font-size: 13px;"><strong>Error:</strong> ${data.error || data.message}</p>
                    </div>
                </div>
                <div class="alert-box info">
                    <div style="font-size: 18px;">üí°</div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 13px;">Update your HEADER credentials using the "Update Credentials" tab</p>
                    </div>
                </div>
            `;

            showAlert('‚ùå Header test failed', 'error');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = 'üöÄ Run Test';

        resultsText.textContent = JSON.stringify({
            error: error.message,
            message: 'Network error or server is not responding'
        }, null, 2);

        summaryDiv.innerHTML = `
            <div class="alert-box error">
                <div style="font-size: 20px;">‚ùå</div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 4px 0; font-size: 14px;">Network Error</h4>
                    <p style="margin: 0; font-size: 13px;">${error.message}</p>
                </div>
            </div>
        `;

        showAlert('‚ùå Network error: ' + error.message, 'error');
    });
}

function copyJsonToClipboard() {
    const resultsText = document.getElementById('testResultsText');
    navigator.clipboard.writeText(resultsText.textContent);
    showAlert('‚úÖ JSON copied to clipboard!', 'success');
}

function copyCurlToClipboard() {
    const curlText = document.getElementById('curlCommandText');
    navigator.clipboard.writeText(curlText.textContent);
    showAlert('‚úÖ cURL copied to clipboard!', 'success');
}

function showAlert(message, type) {
    const alertsDiv = document.getElementById('alerts');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertsDiv.appendChild(alertDiv);

    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}
